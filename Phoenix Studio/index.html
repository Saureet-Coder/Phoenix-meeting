<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Studio</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/alpinejs" defer></script>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-app.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.0.1/firebase-firestore.js"></script>
    <script >
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDdTSisdaBhcWK9WyQPW7z4G5KRU3lfd9Y",
        authDomain: "phoenix-studio-17593.firebaseapp.com",
        projectId: "phoenix-studio-17593",
        storageBucket: "phoenix-studio-17593.appspot.com",
        messagingSenderId: "56312194521",
        appId: "1:56312194521:web:16ebed44e88e05a03525c8"
      };
    
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      let firestore = firebase.firestore();
    </script>
    
    <!-- -->
</head>
<body class="bg-gray-800 min-h-screen">
  <div class="text-gray-100 container mx-auto" x-data="data()" >
<!-- Not meeting Started -->
    <!-- <div class="">
      <img src="assets/undraw_Video_streaming_re_v3qg.svg" alt="" class="absolute  w-72 left-0" >
      <img src="assets/undraw_Video_call_re_4p26.svg" alt="" class="absolute  w-72 right-0" >
      <div class="flex items-center justify-center text-4xl font-bold text-green-200 ">Phoenix Studio</div>
      <div class="flex items-center justify-center min-h-screen" x-show="!meetingStarted">
        
        <input type="text" class="py-1.5 px-4 border-2 border-gray-900 rounded-l focus:outline-none text-gray-900" placeholder="Enter Meeting Title" x-model="meetingTitle">
        <button class="bg-gray-600 text-gray-100 py-2 px-4 rounded-r shadow" @click="createRoom()">Create Room</button>
      
        <div class="">Create Or Join A room</div>  
      </div>
    </div> -->
    <div class="" x-show="!meetingStarted">
      <img src="assets/undraw_Video_streaming_re_v3qg.svg" alt="" class="absolute h-56  left-0" >
      <img src="assets/undraw_Video_call_re_4p26.svg" alt="" class="absolute h-56  right-0" >
      <div class="text-5xl font-bold text-green-200 text-center mt-36 ">Phoenix Studio</div>
      <div class="text-center" x-show="!meetingStarted">
        
        <div class="" >
          <input type="text" class="py-1.5 px-4 border-2 border-gray-900 rounded-l text-gray-900" placeholder="Enter Meeting Title" x-model="meetingTitle" @click="createRoom()">
          <button class="bg-gray-600 text-gray-100 py-2 px-4 rounded-r shadow mt-12" @click="createRoom()">Create A Meeting</button>
        </div>
        <div class="">
          <input type="text" class="py-1.5 px-4 border-2 border-gray-900 rounded-l text-gray-900" placeholder="Enter Meeting Code" x-model="meetingCode" @click="joinRoom()">
          <button class="bg-gray-600 text-gray-100 py-2 px-4 rounded-r shadow mt-12" @click="joinRoom()">Join A Existing Meeting</button>
        </div>
        <div class="mt-24">Hope You Enjoyed This Platform.Thanks For Visiting</div>
      </div>
    </div>
     <!-- Footer -->
     <footer>
    
      
    <div x-show="!meetingStarted" class="p-6 md:p-16 text-center text-white">&copy; Saureet Chakrabarti</div>
  </footer>

  <div class="" x-show="meetingStarted">
    
      <!-- Participants -->
      <div class="flex mt-6 space-x-6">
        <video id="screenShare" class="w-3/4  rounded-xl " x-show="flags.shareScreen"></video>
        <div class=" " x-show="meetingStarted" :class="!flags.shareScreen ? 'grid grid-cols-4 gap-6' :'w-1/4 grid grid-cols-2 gap-2' ">
          <video  id="myVideo" autoplay class="rounded-xl "></video>
          <template x-for="participant in participants">
              <div class="relative">
                  <img src="https://images.unsplash.com/flagged/photo-1570612861542-284f4c12e75f?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1470&q=80" class="rounded-xl">
                  <div class="absolute bottom-0 bg-gray-900 py-2 px-4 w-full bg-opacity-30 flex justify-between">
                      <span x-text="participant.name"></span>
                      <div class="flex" x-show="isAdmin">
                          <button class="hover:bg-gray-800 rounded-full p-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                              </svg>
                          </button>
                          <button class="hover:bg-gray-800 rounded-full p-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                              </svg>
                          </button>
                      </div>
                  </div>
              </div>
          </template>
            </div>
      </div>
      <!-- Bottom Bar -->
      <div class="absolute bottom-0 left-0 w-full p-8 bg-gray-900 flex justify-between items-center" >
        <!-- Time -->
        <span class="" x-text="time"></span>
        <div class="flex items-center" x-show="meetingStarted">
          <span x-ref="meetingCode" x-text="meetingCode"></span>
          <!-- Copy to Clipboard -->
          <a href="#" class="ml-3 mt-1  h-6 w-6 bg-gray-800 flex items-center justify-center rounded"
            @click="navigator.clipboard.writeText($refs.meetingCode.innerHTML)"><svg xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg></a>
        </div>
    
        <!-- Middle Bottom Bar -->
        <div class="flex items-center justify-between space-x-4 ">
          <a href="#" class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center relative"
            @click="toggleMic">
            <!-- Microphone -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"
              x-bind:class="flags.isMic ? 'text-red-500  ' : ''">
              <path fill-rule="evenodd"
                d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"
                clip-rule="evenodd" />
            </svg>
            <!-- Ban Microphone -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 absolute top-0 left-0" fill="none"
              viewBox="0 0 24 24" stroke="currentColor" x-show="flags.isMic">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          </a>
          <a href="#" class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center relative"
            @click="toggleCam">
            <!-- Camera -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"
              x-bind:class="flags.isCam ? 'text-red-500  ' : ''">
              <path
                d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
            </svg>
            <!-- Ban Camera -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 absolute top-0 left-0" fill="none"
              viewBox="0 0 24 24" stroke="currentColor" x-show="flags.isCam">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          </a>
          <!-- Hand Raised -->
          <a href="#" class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center relative"
            @click="handRaised" x-bind:class="flags.handRaised ? 'bg-green-500' : ''">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M9 3a1 1 0 012 0v5.5a.5.5 0 001 0V4a1 1 0 112 0v4.5a.5.5 0 001 0V6a1 1 0 112 0v5a7 7 0 11-14 0V9a1 1 0 012 0v2.5a.5.5 0 001 0V4a1 1 0 012 0v4.5a.5.5 0 001 0V3z"
                clip-rule="evenodd" />
            </svg>
          </a>
          <!-- Share Screen -->
          <a href="#" class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center relative"
            x-on:click="shareScreen">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
              x-show="!flags.shareScreen">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
            <!-- Close Share Screen -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
              x-show="flags.shareScreen"
              x-bind:class="flags.shareScreen ? 'bg-green-800 rounded-full h-10 w-10 font-noraml': ''">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </a>
          <div class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center relative" >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" @click="moreInfo">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
            </svg>
            <div class="p-6 bg-gray-900 rounded-lg shadow-xl text-gray-200 shadow absolute left-0 bottom-16" x-show="flags.moreInfo">
                <div class="">
                    <label for="">Cameras</label>
                    <select name="" class="w-48 bg-gray-700 py-2 px-4 mt-2 focus:outline-none" @change="setDevices()" x-model="selectedCamera">
                        <option value="">Select a camera</option>
                        <template x-for="camera in cameras">
                            <option :value="camera.deviceId" x-text="camera.label"></option>
                        </template>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="">Microphones</label>
                    <select name="" class="w-48 bg-gray-700 py-2 px-4 mt-2 focus:outline-none">
                        <option value="">Select a microphone</option>
                        <template x-for="microphone in microphones">
                            <option value="" x-text="microphone.label"></option>
                        </template>
                    </select>
                </div>
                <div class="mt-4">
                    <label for="">Speakers</label>
                    <select name="" class="w-48 bg-gray-700 py-2 px-4 mt-2 focus:outline-none">
                        <option value="">Select a speaker</option>
                        <template x-for="speaker in speakers">
                            <option value="" x-text="speaker.label"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>
          <!-- End Call -->
          <a href="#" class="h-12 w-16 rounded-full bg-red-500 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path
                d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
            </svg>
          </a>
        </div>
        <div class="flex  space-x-4">
          <!-- Info -->
          <a href="" class="">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </a>
          <!-- Participants People Users -->
          <a href="" class="">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <div class="bg-black px-2 py-1 rounded-full absolute top-5 right-24">12</div>
          </a>
          <!-- Chat -->
          <a href="" class="">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
          </a>
          <!-- Notes -->
        <a href="#" class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" @click="toggleNotes()">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
          <div x-show="flags.isNotes" class="bg-white absolute bottom-10 right-0 h-96 w-96 rounded-t shadow overflow-hidden">
              <div class="bg-blue-500 text-white py-3 px-4 rounded-t">Notes</div>
              <textarea class="text-gray-900 h-full w-full focus:outline-none p-4" x-text="meetingNotes">

              </textarea>
          </div>
      </a>
        </div>
      </div>
    </div>
  </div>



  <script>
    function data() {
      return {
        
        isAdmin: false,
        time: "__:__",
        flags: {
          isMic: false,
          isCam: false,
          handRaised: false,
          shareScreen: false,
          moreInfo: false,
          isNotes: false,
        },
        meetingTitle: "",
        meetingCode: "",
        meetingStarted: false,
        meetingNotes: "",

        // shortcut(e){
        //   console.log(e.code);
        // },


        roomExists(){
          // TODO: Check firebase before returning a value
          return true;
        },

        getRoom(){
          let url = new URL(location.href);
          let params = new URLSearchParams(url.search);
          
          this.meetingCode = params.get("fm");
          if (this.meetingCode !== null && roomExists()) {
            this.meetingStarted = true;
            this.setDevices();
            this.getDevices();
          }
        },
        rtcConfig: {
          iceServers: [
            {
              urls: "stun:stun.services.mozilla.com",
            },
            {
              urls: "stun:stun.l.google.com:19302",
            },
          ],
        },
        peerConnection: null,
        createRoom: async function(){
          let $this = this;
          await this.getDevices();
          await this.setDevices();
            // Store data in firebase
            $this.peerConnection = new RTCPeerConnection($this.rtcConfig);
            $this.combinedStream.getTracks().forEach(
              track => this.peerConnection.addTrack( track, $this.combinedStream)
            );
            let roomRef = firestore.collection("rooms").doc();
            const callerCandidatesCollection = roomRef.collection("callerCandidates");
            this.meetingCode = roomRef.id;

            $this.peerConnection.addEventListener("icecandidate", event => {
              if (!event.candidate) {
                return;
              }
              callerCandidatesCollection.add(event.candidate.toJSON());
            });

            const offer = await $this.peerConnection.createOffer();
            await $this.peerConnection.setLocalDescription(offer);

            const roomWithOffer = {
              meetingTitle:this.meetingTitle,
              meetingCode: this.meetingCode,
              offer: {
                type: offer.type,
                sdp: offer.sdp,

              },
              roomId: roomRef.id,
            };
            roomRef.set(roomWithOffer);





                    this.meetingStarted = true;
                    window.history.replaceState({}, "", "?mf="+ this.meetingCode);
                    document.title = "ðŸ”¥ " + this.meetingTitle;
                    
                },

                joinRoom: async function(){
                  let $this = this;
                  $this.peerConnection = new RTCPeerConnection($this.rtcConfig);
                  
                  const roomRef = firestore.collection("rooms").doc($this.meetingCode);
                  const roomSnapshot = await roomRef.get();

                  if (roomSnapshot.exists) {
                    console.log("Meeting Room Found")
                  } else{
                    console.log("Cant find")
                  }
                },


        selectedCamera: null,
        selectedMicrophone: null,
        selectedSpeakers: null,
        cameras: [
          
        ],
        microphones: [],
        speakers: [],
        init() {
          this.currentTime();
          this.getDevices();
          this.getRoom();
        },
        getDevices: async function () {
          let $this = this;
          navigator.mediaDevices.enumerateDevices().then(function (devices) {
            devices.forEach(function (device) {
              if (device.kind == "audioinput") {
                $this.microphones.push(device);
              } else if (device.kind == "audiooutput") { $this.speakers.push(device); 
              } else if (device.kind == "videoinput") { $this.cameras.push(device); }
            });
          });
            // set Devices
            this.setDevices()
        },
        toggleMic() {
          this.flags.isMic = !this.flags.isMic;
        },
        toggleCam() {

          this.flags.isCam = !this.flags.isCam;
        },
        handRaised() {

          this.flags.handRaised = !this.flags.handRaised;
        },
        stopScreenShare(){
          var tracks = this.stream.getTracks();
            tracks[0].stop();
            this.flags.shareScreen = false;
        },
        stream: null,
        shareScreen: async function() {
          if (!this.flags.shareScreen) {
            
          this.stream = await navigator.mediaDevices.getDisplayMedia();
          myScreen = document.getElementById("screenShare")
          myScreen.srcObject = this.stream;
          this.stream.getVideoTracks()[0].addEventListener("ended", ()=> {
            this.stopScreenShare();
          });
          this.flags.shareScreen = true;
          } else {
            this.stopScreenShare();
          }

        },
        moreInfo() {

          this.flags.moreInfo = !this.flags.moreInfo;
        },
        
        toggleNotes(){
                    this.flags.isNotes = !this.flags.isNotes;
                },
        participants: [
          {
            name: "Alice",
          },
          {
            name: "Bob",
          },
          {
            name: "Charlie",
          },
          {
            name: "elizabeth",
          },
          {
            name: "farah",
          },
          {
            name: "george",
          },















          
          {
            name: "hard",
          },

        ],
        combinedStream: null,
        setDevices: async function(){
          let videoDevice = this.selectedCamera !== null ? {deviceId: this.selectedCamera} : true;
          
            let videoStream = await navigator.mediaDevices.getUserMedia({
            video: videoDevice,
            audio: false,
          });
          let audioStream = await navigator.mediaDevices.getUserMedia({
            video: false,
            audio: true,
          });
          this.combinedStream = new MediaStream([...videoStream.getVideoTracks(),...audioStream.getAudioTracks(),]);
          myVideoElement =  document.getElementById("myVideo");
          myVideoElement.srcObject = this.combinedStream;
          myVideoElement.muted = true;
          },

        currentTime() {
          let $this = this;
          setInterval(function () {
            var date = new Date();
            let minutes = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
            let hours = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
            $this.time = `${date.getHours()}:${minutes} | `;

          }, 1000);
        }
      };
    }
  </script>

</body>

</html>